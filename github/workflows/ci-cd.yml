name: CI/CD Pipeline

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  ì¡°ê±´ë“¤
on:
  # main ë¸Œëœì¹˜ì— pushí•  ë•Œ
  push:
    branches: [ main, master ]
  # Pull Requestê°€ main ë¸Œëœì¹˜ë¡œ ìš”ì²­ë  ë•Œ
  pull_request:
    branches: [ main, master ]

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  JAVA_VERSION: '17'
  GRADLE_VERSION: 'wrapper'

jobs:
  # CI ì‘ì—…: ì½”ë“œ ê²€ì¦ ë° í…ŒìŠ¤íŠ¸
  test:
    runs-on: ubuntu-latest
    name: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ ê²€ì¦
    
    steps:
    # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    # 2. JDK 17 ì„¤ì •
    - name: JDK 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        
    # 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
    - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      run: chmod +x ./gradlew
      
    # 4. Gradle ìºì‹œ ì„¤ì • (ë¹Œë“œ ì†ë„ í–¥ìƒ)
    - name: Gradle ìºì‹œ ì„¤ì •
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    # 5. ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ
    - name: ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ
      run: ./gradlew dependencies
      
    # 6. ì½”ë“œ ì»´íŒŒì¼
    - name: ì½”ë“œ ì»´íŒŒì¼
      run: ./gradlew compileJava
      
    # 7. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: ./gradlew test
      
    # 8. WAR íŒŒì¼ ë¹Œë“œ
    - name: WAR íŒŒì¼ ë¹Œë“œ
      run: ./gradlew clean build
      
    # 9. ë¹Œë“œëœ WAR íŒŒì¼ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
    - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: war-file
        path: build/libs/*.war
        retention-days: 30

  # CD ì‘ì—…: ë°°í¬ (í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰)
  deploy:
    runs-on: ubuntu-latest
    name: ë°°í¬
    needs: test  # test ì‘ì—…ì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰ë¨
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'  # main/master ë¸Œëœì¹˜ì—ë§Œ ë°°í¬
    
    steps:
    # 1. ë¹Œë“œëœ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
    - name: ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v3
      with:
        name: war-file
        path: ./artifacts
        
    # 2. ë°°í¬ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ ì„œë²„ ë°°í¬ë¡œ ëŒ€ì²´ ê°€ëŠ¥)
    - name: ë°°í¬ ì‹œë®¬ë ˆì´ì…˜
      run: |
        echo "ğŸš€ ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        echo "ğŸ“¦ WAR íŒŒì¼ í™•ì¸:"
        ls -la ./artifacts/
        echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        
    # 3. Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
    # - name: Slack ì•Œë¦¼
    #   if: always()
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: ${{ job.status }}
    #     channel: '#deployment'
    #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
