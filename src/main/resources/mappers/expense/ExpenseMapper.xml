<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.bbagisix.expense.mapper.ExpenseMapper">
    <insert id="insert" parameterType="org.bbagisix.expense.domain.ExpenseVO" useGeneratedKeys="true"
            keyProperty="expenditureId">
        INSERT INTO expenditure (user_id, category_id, asset_id, amount, description, expenditure_date)
        VALUES (#{userId}, #{categoryId}, #{assetId}, #{amount}, #{description}, #{expenditureDate})
    </insert>

    <select id="findById" parameterType="long" resultType="org.bbagisix.expense.domain.ExpenseVO">
        SELECT expenditure_id,
               user_id,
               category_id,
               asset_id,
               amount,
               description,
               expenditure_date,
               created_at,
               updated_at
        FROM expenditure
        WHERE expenditure_id = #{expenditureId}
    </select>

    <select id="findAllByUserId" parameterType="long" resultType="org.bbagisix.expense.domain.ExpenseVO">
        SELECT expenditure_id,
               user_id,
               category_id,
               asset_id,
               amount,
               description,
               expenditure_date,
               created_at,
               updated_at
        FROM expenditure
        WHERE user_id = #{userId}
        ORDER BY expenditure_date DESC
    </select>

    <select id="findAllByUserIdWithDetails" parameterType="long" resultType="org.bbagisix.expense.dto.ExpenseDTO">
        SELECT e.expenditure_id as expenditureId,
               e.user_id as userId,
               e.category_id as categoryId,
               e.asset_id as assetId,
               e.amount,
               e.description,
               e.expenditure_date as expenditureDate,
               e.created_at as createdAt,
               e.updated_at as updatedAt,
               c.name as categoryName,
               c.icon as categoryIcon,
               a.asset_name as assetName,
               a.bank_name as bankName
        FROM expenditure e
        LEFT JOIN category c ON e.category_id = c.category_id
        LEFT JOIN user_asset a ON e.asset_id = a.asset_id
        WHERE e.user_id = #{userId}
        ORDER BY e.expenditure_date DESC
    </select>

    <update id="update" parameterType="org.bbagisix.expense.domain.ExpenseVO">
        UPDATE expenditure
        SET category_id      = #{categoryId},
            asset_id         = #{assetId},
            amount           = #{amount},
            description      = #{description},
            expenditure_date = #{expenditureDate}
        WHERE expenditure_id = #{expenditureId}
          AND user_id = #{userId}
    </update>

    <delete id="delete">
        DELETE
        FROM expenditure
        WHERE expenditure_id = #{param1}
          AND user_id = #{param2}
    </delete>

    <select id="getRecentExpenses" parameterType="long" resultType="org.bbagisix.expense.domain.ExpenseVO">
        SELECT *
        FROM expenditure
        WHERE user_id = #{userId}
          AND expenditure_date >= DATE_SUB(CURDATE(), INTERVAL 2 MONTH)
        ORDER BY expenditure_date DESC
    </select>

    <select id="getTodayExpenseCategories" parameterType="long" resultType="long">
        SELECT category_id
        FROM expenditure
        WHERE user_id = #{userId}
          AND DATE (expenditure_date)=CURDATE()
    </select>

    <select id="getSumOfPeriodExpenses" resultType="long">
        SELECT SUM(amount)
        FROM expenditure
        WHERE user_id = #{userId}
          AND category_id = #{categoryId}
          AND expenditure_date
            BETWEEN DATE_SUB(CURDATE() - INTERVAL 1 DAY, INTERVAL #{period} DAY)
            AND (CURDATE() - INTERVAL 1 DAY)
    </select>

    <insert id="insertExpenses" parameterType="java.util.List">
        INSERT INTO expenditure (
            user_id,
            asset_id,
            category_id,
            amount,
            description,
            expenditure_date,
            created_at
        ) VALUES
        <foreach collection="list" item="expense" separator=",">
            (
                #{expense.userId},
                #{expense.assetId},
                #{expense.categoryId},
                #{expense.amount},
                #{expense.description},
                #{expense.expenditureDate},
                NOW()
            )
        </foreach>
    </insert>
</mapper>